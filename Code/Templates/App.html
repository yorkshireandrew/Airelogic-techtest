<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <title>Health Test - App</title>
  </head>
  <body>
    <div id="root"></div>

    <!-- React (development) and Babel for on-the-fly JSX transpilation in dev/demo -->
    <script src="https://unpkg.com/react@18/umd/react.development.js"></script>
    <script src="https://unpkg.com/react-dom@18/umd/react-dom.development.js"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>

    <script type="text/babel">
      const { useEffect, useRef, useState } = React;

      const daysInMonth = (y, m) => new Date(y, m, 0).getDate();

      function LandingPage({ visible = true }) {
        const formRef = useRef(null);
        const nhsRef = useRef(null);
        const surnameRef = useRef(null);
        const dayRef = useRef(null);
        const monthRef = useRef(null);
        const yearRef = useRef(null);

        useEffect(() => {
          try { if (formRef.current) formRef.current.reset(); } catch (e) {}
        }, []);

        if (!visible) return null;

        const clearDobValidity = () => {
          if (dayRef.current) dayRef.current.setCustomValidity('');
          if (monthRef.current) monthRef.current.setCustomValidity('');
          if (yearRef.current) yearRef.current.setCustomValidity('');
        };

        const validateDob = () => {
          const dEl = dayRef.current, mEl = monthRef.current, yEl = yearRef.current;
          if (!dEl || !mEl || !yEl) return true;
          const d = parseInt(dEl.value, 10);
          const m = parseInt(mEl.value, 10);
          const y = parseInt(yEl.value, 10);
          if (Number.isNaN(d) || Number.isNaN(m) || Number.isNaN(y)) {
            dEl.setCustomValidity('Please enter a valid numeric date of birth');
            return false;
          }
          if (m < 1 || m > 12) { mEl.setCustomValidity('Month must be between 1 and 12'); return false; }
          const dim = daysInMonth(y, m);
          if (d < 1 || d > dim) { dEl.setCustomValidity('Day is invalid for the selected month and year'); return false; }
          const dob = new Date(y, m - 1, d);
          if (dob > new Date()) { dEl.setCustomValidity('Date of birth cannot be in the future'); return false; }
          clearDobValidity();
          return true;
        };

        const handleSubmit = (e) => {
          if (nhsRef.current) nhsRef.current.value = nhsRef.current.value.trim();
          if (surnameRef.current) surnameRef.current.value = surnameRef.current.value.trim();
          if (surnameRef.current && surnameRef.current.value === '') {
            surnameRef.current.setCustomValidity('Please enter your surname');
            e.preventDefault(); if (surnameRef.current.reportValidity) surnameRef.current.reportValidity(); return;
          }
          if (nhsRef.current) {
            const v = nhsRef.current.value; if (!/^\d{9,10}$/.test(v)) {
              nhsRef.current.setCustomValidity('NHS number must be a 9 or 10-digit numeric value');
              e.preventDefault(); if (nhsRef.current.reportValidity) nhsRef.current.reportValidity(); return;
            }
          }
          clearDobValidity(); if (!validateDob()) { e.preventDefault(); if (dayRef.current && dayRef.current.reportValidity) dayRef.current.reportValidity(); }
        };

        return (
          <div>
            <h1>Health Test Questionnaire</h1>
            <form id="health-form" ref={formRef} method="post" action="/landing-submit" onSubmit={handleSubmit}>
              <div>
                <label htmlFor="nhs">NHS Number</label><br />
                <input id="nhs" name="nhs" type="text" pattern="[0-9]{9,10}" inputMode="numeric" maxLength={10} required placeholder="1234567890" title="Enter a 9- or 10-digit NHS number" ref={nhsRef} onInput={() => nhsRef.current && nhsRef.current.setCustomValidity('')} />
              </div>
              <div>
                <label htmlFor="surname">Surname</label><br />
                <input id="surname" name="surname" type="text" required ref={surnameRef} onInput={() => surnameRef.current && surnameRef.current.setCustomValidity('')} />
              </div>
              <fieldset>
                <legend>Date of Birth</legend>
                <label htmlFor="dob-day">Day</label>
                <input id="dob-day" name="dob_day" type="number" min="1" max="31" required style={{width:'5rem'}} ref={dayRef} onInput={() => dayRef.current && dayRef.current.setCustomValidity('')} />
                <label htmlFor="dob-month">Month</label>
                <input id="dob-month" name="dob_month" type="number" min="1" max="12" required style={{width:'5rem'}} ref={monthRef} onInput={() => monthRef.current && monthRef.current.setCustomValidity('')} />
                <label htmlFor="dob-year">Year</label>
                <input id="dob-year" name="dob_year" type="number" min="1800" max="2100" required style={{width:'6rem'}} ref={yearRef} onInput={() => yearRef.current && yearRef.current.setCustomValidity('')} />
              </fieldset>
              <div><button type="submit">Submit</button></div>
            </form>
          </div>
        );
      }

      function QuestionnairePage({ visible = true }) {
        const [questions, setQuestions] = useState([]);
        const [selectedAnswers, setSelectedAnswers] = useState(new Set());
        const [ageBand, setAgeBand] = useState('');

        useEffect(() => {
          let cancelled = false;
          async function load() {
            try {
              const res = await fetch('/api/questions');
              if (!res.ok) throw new Error('fetch failed');
              const body = await res.json();
              if (cancelled) return;
              setQuestions(Array.isArray(body.questions) ? body.questions : []);
              setAgeBand(body.ageBand || '');
              setSelectedAnswers(new Set());
            } catch (e) {
              if (!cancelled) { setQuestions([]); setSelectedAnswers(new Set()); }
            }
          }
          load();
          return () => { cancelled = true; };
        }, []);

        if (!visible) return null;
        const totalQuestions = questions.length;

        const onAnswerChange = (name) => {
          setSelectedAnswers(prev => {
            const copy = new Set(prev);
            const prefix = name.charAt(0);
            const number = name.substring(1);
            const other = (prefix === 'Y' ? 'N' : 'Y') + number;
            if (copy.has(name)) { copy.delete(name); } else { copy.add(name); if (copy.has(other)) copy.delete(other); }
            return copy;
          });
        };

        const isSubmitEnabled = selectedAnswers.size === totalQuestions;

        return (
          <div>
            <h1>Health Test Questionnaire</h1>
            <form id="health-form" method="post" action="/questionnaire-submit">
              <table>
                <thead>
                  <tr><th>Question</th><th>Yes</th><th>No</th></tr>
                </thead>
                <tbody>
                  {questions.map((q, i) => (
                    <tr key={i}>
                      <td>{q}</td>
                      <td><input type="radio" name={`Y${i}`} onChange={() => onAnswerChange(`Y${i}`)} checked={selectedAnswers.has(`Y${i}`)} /></td>
                      <td><input type="radio" name={`N${i}`} onChange={() => onAnswerChange(`N${i}`)} checked={selectedAnswers.has(`N${i}`)} /></td>
                    </tr>
                  ))}
                </tbody>
              </table>
              <input type="hidden" name="AgeBand" value={ageBand} />
              <input type="hidden" name="TotalQuestions" value={totalQuestions} />
              <button id="health-submit" type="submit" disabled={!isSubmitEnabled}>Submit</button>
            </form>
          </div>
        );
      }

      function AnswerPage({ visible = true, message = '' }) {
        if (!visible) return null;
        return (
          <div>
            <h1>Health Test Questionnaire</h1>
            <div><p>{message}</p></div>
          </div>
        );
      }

      function Application() {
        const [showLanding] = useState(true);
        return (
          <div>
            <LandingPage visible={showLanding} />
          </div>
        );
      }

      ReactDOM.createRoot(document.getElementById('root')).render(<Application />);
    </script>
  </body>
</html>
